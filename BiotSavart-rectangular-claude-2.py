# -*- coding: utf-8 -*-
"""
Created on Tue Feb  3 00:12:43 2026

@author: dsotn
"""

"""
Magnetic Field Calculator for a Rectangular Conductor with Uniform Current Distribution

This script calculates the magnetic field components (Bx, By) at a point (x0, y0)
generated by a rectangular conductor of width w and height h carrying current I.

The solution uses the Biot-Savart law with numerical integration.
"""

import numpy as np
from scipy import integrate
import matplotlib.pyplot as plt


# Physical constants
MU_0 = 4 * np.pi * 1e-7  # Vacuum permeability (T·m/A)


def magnetic_field_rectangular(x0, y0, w, h, I, n_points=100):
    """
    Calculate magnetic field components at point (x0, y0) from a rectangular
    conductor centered at origin with uniform current distribution.
    
    Parameters:
    -----------
    x0, y0 : float
        Observation point coordinates (m)
    w : float
        Width of rectangle in x-direction (m)
    h : float
        Height of rectangle in y-direction (m)
    I : float
        Total current through the rectangle (A)
    n_points : int
        Number of integration points per dimension
    
    Returns:
    --------
    Bx, By : float
        Magnetic field components (T)
    
    Notes:
    ------
    - Rectangle is centered at origin, extending from -w/2 to w/2 in x
      and from -h/2 to h/2 in y
    - Current flows in the z-direction (out of plane)
    - Uses Biot-Savart law: dB = (μ₀/4π) * (J × r̂) / r² dV
    """
    
    # Current density (A/m²) - current per unit area
    J = I / (w * h)
    
    # Integration limits (rectangle boundaries)
    x_min, x_max = -w/2, w/2
    y_min, y_max = -h/2, h/2
    
    def integrand_Bx(y_prime, x_prime):
        """Integrand for Bx component"""
        # Distance vector from source point to observation point
        dx = x0 - x_prime
        dy = y0 - y_prime
        r_squared = dx**2 + dy**2
        
        # Avoid singularity at the observation point
        if r_squared < 1e-20:
            return 0.0
        
        r_cubed = r_squared ** 1.5
        
        # From Biot-Savart: J is in z-direction, so J × r has components
        # Bx comes from J_z * (-dy) / r³
        # (J × r)_x = J_z * (y0 - y') 
        return J * (y0 - y_prime) / r_cubed
    
    def integrand_By(y_prime, x_prime):
        """Integrand for By component"""
        dx = x0 - x_prime
        dy = y0 - y_prime
        r_squared = dx**2 + dy**2
        
        if r_squared < 1e-20:
            return 0.0
        
        r_cubed = r_squared ** 1.5
        
        # (J × r)_y = J_z * (-(x0 - x')) = -J_z * (x0 - x')
        return -J * (x0 - x_prime) / r_cubed
    
    # Numerical integration using scipy's dblquad
    # Note: dblquad integrates as ∫∫ f(y,x) dy dx
    Bx_integral, Bx_error = integrate.dblquad(
        integrand_Bx, 
        x_min, x_max,  # x limits
        y_min, y_max,  # y limits (can be functions of x)
        epsabs=1e-10, epsrel=1e-10
    )
    
    By_integral, By_error = integrate.dblquad(
        integrand_By,
        x_min, x_max,
        y_min, y_max,
        epsabs=1e-10, epsrel=1e-10
    )
    
    # Apply the Biot-Savart prefactor (μ₀/4π)
    prefactor = MU_0 / (4 * np.pi)
    
    Bx = prefactor * Bx_integral
    By = prefactor * By_integral
    
    return Bx, By


def magnetic_field_grid(x_range, y_range, w, h, I, nx=50, ny=50):
    """
    Calculate magnetic field on a 2D grid.
    
    Parameters:
    -----------
    x_range, y_range : tuple
        (min, max) for x and y coordinates
    w, h : float
        Rectangle dimensions
    I : float
        Current
    nx, ny : int
        Number of grid points
    
    Returns:
    --------
    X, Y : ndarray
        Meshgrid coordinates
    Bx, By : ndarray
        Field components on grid
    """
    x = np.linspace(x_range[0], x_range[1], nx)
    y = np.linspace(y_range[0], y_range[1], ny)
    X, Y = np.meshgrid(x, y)
    
    Bx = np.zeros_like(X)
    By = np.zeros_like(Y)
    
    for i in range(ny):
        for j in range(nx):
            # Skip points inside the rectangle (field is undefined there)
            if abs(X[i,j]) < w/2 and abs(Y[i,j]) < h/2:
                Bx[i,j] = np.nan
                By[i,j] = np.nan
            else:
                Bx[i,j], By[i,j] = magnetic_field_rectangular(X[i,j], Y[i,j], w, h, I)
    
    return X, Y, Bx, By


def plot_magnetic_field(w, h, I, plot_range=None):
    """
    Create visualization of the magnetic field.
    """
    if plot_range is None:
        plot_range = max(w, h) * 2
    
    # Calculate field on grid
    margin = plot_range
    X, Y, Bx, By = magnetic_field_grid(
        (-margin, margin), (-margin, margin),
        w, h, I, nx=25, ny=25
    )
    
    # Calculate field magnitude
    B_mag = np.sqrt(Bx**2 + By**2)
    
    # Create figure with subplots
    fig, axes = plt.subplots(1, 2, figsize=(14, 6))
    
    # Plot 1: Vector field (streamplot)
    ax1 = axes[0]
    
    # Draw the rectangle
    rect = plt.Rectangle((-w/2, -h/2), w, h, fill=True, 
                         facecolor='lightblue', edgecolor='blue', 
                         linewidth=2, alpha=0.7)
    ax1.add_patch(rect)
    
    # Streamplot for field lines
    # Replace NaN with zeros for plotting
    Bx_plot = np.nan_to_num(Bx, nan=0)
    By_plot = np.nan_to_num(By, nan=0)
    
    strm = ax1.streamplot(X, Y, Bx_plot, By_plot, color=np.log10(B_mag + 1e-15),
                          cmap='viridis', density=1.5, linewidth=1)
    
    ax1.set_xlim(-margin, margin)
    ax1.set_ylim(-margin, margin)
    ax1.set_xlabel('x (m)')
    ax1.set_ylabel('y (m)')
    ax1.set_title(f'Magnetic Field Lines\nRectangle: {w}m × {h}m, I = {I} A')
    ax1.set_aspect('equal')
    ax1.grid(True, alpha=0.3)
    plt.colorbar(strm.lines, ax=ax1, label='log₁₀(|B|) (T)')
    
    # Plot 2: Field magnitude contour
    ax2 = axes[1]
    
    rect2 = plt.Rectangle((-w/2, -h/2), w, h, fill=True,
                          facecolor='white', edgecolor='blue',
                          linewidth=2, alpha=0.9)
    ax2.add_patch(rect2)
    
    # Higher resolution for contour
    X_fine, Y_fine, Bx_fine, By_fine = magnetic_field_grid(
        (-margin, margin), (-margin, margin),
        w, h, I, nx=50, ny=50
    )
    B_mag_fine = np.sqrt(Bx_fine**2 + By_fine**2)
    
    # Use log scale for better visualization
    with np.errstate(divide='ignore', invalid='ignore'):
        log_B = np.log10(B_mag_fine)
    
    contour = ax2.contourf(X_fine, Y_fine, log_B, levels=20, cmap='plasma')
    ax2.contour(X_fine, Y_fine, log_B, levels=10, colors='black', alpha=0.3, linewidths=0.5)
    
    ax2.set_xlim(-margin, margin)
    ax2.set_ylim(-margin, margin)
    ax2.set_xlabel('x (m)')
    ax2.set_ylabel('y (m)')
    ax2.set_title(f'Magnetic Field Magnitude\nRectangle: {w}m × {h}m, I = {I} A')
    ax2.set_aspect('equal')
    plt.colorbar(contour, ax=ax2, label='log₁₀(|B|) (T)')
    
    plt.tight_layout()
    return fig


# Main execution
if __name__ == "__main__":
    # Define parameters
    w = 0.02      # Width: 2 cm
    h = 0.01      # Height: 1 cm
    I = 10.0      # Current: 10 A
    
    # Calculate field at a specific point
    x0, y0 = 0.03, 0.02  # Observation point (3 cm, 2 cm)
    
    print("=" * 60)
    print("Magnetic Field from Rectangular Conductor")
    print("=" * 60)
    print(f"\nRectangle dimensions: w = {w*100:.1f} cm, h = {h*100:.1f} cm")
    print(f"Total current: I = {I} A")
    print(f"Current density: J = {I/(w*h):.2f} A/m²")
    print(f"\nObservation point: ({x0*100:.1f} cm, {y0*100:.1f} cm)")
    
    Bx, By = magnetic_field_rectangular(x0, y0, w, h, I)
    B_magnitude = np.sqrt(Bx**2 + By**2)
    B_angle = np.degrees(np.arctan2(By, Bx))
    
    print(f"\nResults:")
    print(f"  Bx = {Bx:.6e} T = {Bx*1e6:.4f} μT")
    print(f"  By = {By:.6e} T = {By*1e6:.4f} μT")
    print(f"  |B| = {B_magnitude:.6e} T = {B_magnitude*1e6:.4f} μT")
    print(f"  Angle = {B_angle:.2f}°")
    
    # Calculate at several test points
    print("\n" + "=" * 60)
    print("Field at various points:")
    print("=" * 60)
    
    test_points = [
        (0.05, 0.0),    # Right of center
        (0.0, 0.03),    # Above center
        (-0.03, 0.03),  # Upper left
        (0.03, -0.02),  # Lower right
    ]
    
    print(f"{'Point (cm)':<20} {'Bx (μT)':<15} {'By (μT)':<15} {'|B| (μT)':<15}")
    print("-" * 65)
    
    for x, y in test_points:
        bx, by = magnetic_field_rectangular(x, y, w, h, I)
        b_mag = np.sqrt(bx**2 + by**2)
        print(f"({x*100:5.1f}, {y*100:5.1f})       {bx*1e6:12.4f}   {by*1e6:12.4f}   {b_mag*1e6:12.4f}")
    
    # Generate and save visualization
    print("\nGenerating visualization...")
    fig = plot_magnetic_field(w, h, I)
    fig.savefig('/home/claude/magnetic_field_plot.png', dpi=150, bbox_inches='tight')
    print("Plot saved to 'magnetic_field_plot.png'")
    
    plt.show()